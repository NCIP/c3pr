<project name="gridportlets" default="help" basedir="..">

    <property file="build.properties"/>
    <property file="config/gridportlets.properties"/>

    <taskdef resource="net/sf/antcontrib/antcontrib.properties">
        <classpath>
            <pathelement location="${gridsphere.home}/lib/ant-contrib-0.3.jar"/>
        </classpath>
    </taskdef>

    <property name="optimize" value="false"/>
    <property name="debug" value="on"/>
    <property name="deprecation" value="true"/>

    <property name="project" value="${project.title} ${project.version}"/>
    <property name="project.api" value="${project.title} API ${project.version}"/>

    <!-- GridSphere build targets -->
    <property name="build.lib" value="${project.build}/lib"/>
    <property name="build.classes" value="${project.build}/classes"/>
    <property name="build.webapp" value="${project.build}/webapp"/>
    <property name="build.docs" value="${project.build}/docs"/>
    <property name="build.javadoc" value="${build.docs}/javadocs"/>
    <property name="build.tests" value="${project.build}/tests"/>

    <property environment="env"/>

    <!-- =================================================================== -->
    <!-- Print usage information                                             -->
    <!-- =================================================================== -->
    <target name="help" description="Displays help about useful ant targets for Grid Portlets">
        <echo message="----------------------------------------------------------------"/>
        <echo message="- Installation Targets                                         -"/>
        <echo message="----------------------------------------------------------------"/>
        <echo message="Target                 Description                              "/>
        <echo message="deploy-gridportlets    Deploys Grid Portlets related files      "/>
        <echo message="undeploy-gridportlets  Undeploys Grid Portlets related files    "/>
        <echo message="----------------------------------------------------------------"/>
        <echo message="                                                                "/>
        <echo message="Note: The above are targets invoked by your default build file. "/>

    </target>

    <!-- =================================================================== -->
    <!-- Installs Grid Portlets Related Files                                -->
    <!-- =================================================================== -->
    <target name="install-gridportlets"
            description="Deploys Grid Portlets Related Files">

        <echo>Installing Grid Portlets related files</echo>

        <antcall target="deploy-gridportlets"/>

    </target>

    <!-- =================================================================== -->
    <!-- Deploys Grid Portlets Related Files                                 -->
    <!-- =================================================================== -->
    <target name="deploy-gridportlets"
            description="Deploys Grid Portlets Related Files">

        <echo>Deploying Grid Portlets related files</echo>

        <antcall target="deploy-gridportlets-jars"/>
        <antcall target="deploy-gridportlets-mapping"/>
        <antcall target="deploy-gridportlets-persistence"/>

        <ant dir="${gridportlets.home}" antfile="build.xml" target="update-database" inheritAll="false"/>

    </target>

    <!-- =================================================================== -->
    <!-- Deploys Grid Portlets Provider Jars To Web Application              -->
    <!-- =================================================================== -->
    <target name="deploy-gridportlets-jars"
            description="Deploys Grid Portlets Provider Jars To Web Application">

        <antcall target="gridportlets-project-jar"/>
        <antcall target="gridportlets-project-entries"/>

        <echo>Deploying Grid Portlets services jars to web application</echo>

        <copy overwrite="true"
              file="build/lib/gridportlets-${project.name}.jar"
              todir="${env.CATALINA_HOME}/webapps/${project.name}/WEB-INF/lib"/>

        <echo>Deploying Grid Portlets provider jars to web application</echo>

        <copy overwrite="true"
              file="${gridportlets.build}/lib/gridportlets-provider.jar"
              todir="${env.CATALINA_HOME}/webapps/${project.name}/WEB-INF/lib"/>

        <echo>Deploying Grid Portlets action component files to web application</echo>

        <mkdir dir="${env.CATALINA_HOME}/webapps/${project.name}/WEB-INF/mapping"/>
        <copy overwrite="true" todir="${env.CATALINA_HOME}/webapps/${project.name}/WEB-INF/mapping">
            <fileset dir="${gridportlets.home}/webapp/WEB-INF/mapping">
                <include name="ActionComponentType.xml"/>
                <include name="JobProfile.xml"/>
                <include name="ResourceProfile.xml"/>
            </fileset>
        </copy>

    </target>

    <!-- =================================================================== -->
    <!-- Deploys Web Application Resource Mappings To Grid Portlets          -->
    <!-- =================================================================== -->
    <target name="deploy-gridportlets-mapping"
            description="Deploys Web Application Resource Mappings To Grid Portlets">

        <echo>Deploying web application resource mappings to Grid Portlets</echo>

        <copy failonerror="false" overwrite="true"
              todir="${env.CATALINA_HOME}/webapps/gridportlets/WEB-INF/mapping/resources/">
            <fileset dir="webapp/WEB-INF/gridportlets/mapping">
                <include name="*.xml"/>
            </fileset>
            <mapper type="glob" from="*.xml" to="*_${project.name}.xml"/>
        </copy>

    </target>

    <!-- =================================================================== -->
    <!-- Deploys Web Application Persistence Mappings To Grid Portlets       -->
    <!-- =================================================================== -->
    <target name="deploy-gridportlets-persistence"
            description="Deploys Web Application Persistence Mappings To Grid Portlets">

        <echo>Deploying web application persistence mappings to Grid Portlets</echo>

        <copy failonerror="false" todir="${env.CATALINA_HOME}/webapps/gridportlets/WEB-INF/persistence">
            <fileset dir="webapp/WEB-INF/gridportlets/persistence">
                <include name="*.xml"/>
            </fileset>
            <mapper type="glob" from="*.hbm.xml" to="*_${project.name}.hbm.xml"/>
        </copy>

    </target>

    <!-- =================================================================== -->
    <!-- Undeploys Grid Portlets Provider Jars From Web Application          -->
    <!-- =================================================================== -->
    <target name="undeploy-gridportlets"
            description="Undeploys Grid Portlets Related Files">

        <echo>Uneploying Grid Portlets related files</echo>

        <antcall target="undeploy-gridportlets-jars"/>
        <antcall target="undeploy-gridportlets-mapping"/>
        <antcall target="undeploy-gridportlets-persistence"/>

        <ant dir="${gridportlets.home}" antfile="build.xml" target="update-database" inheritAll="false"/>

    </target>

    <!-- =================================================================== -->
    <!-- Undeploys Grid Portlets Provider Jars From Web Application          -->
    <!-- =================================================================== -->
    <target name="undeploy-gridportlets-jars"
            description="Undeploys Grid Portlets Provider Jars From Web Application">

        <echo>Undeploying Grid Portlets files from web application</echo>

        <delete failonerror="false"
                file="${env.CATALINA_HOME}/webapps/${project.name}/WEB-INF/lib/gridportlets-${project.name}.jar"/>

        <delete failonerror="false"
                file="${env.CATALINA_HOME}/webapps/${project.name}/WEB-INF/lib/gridportlets-provider.jar"/>

        <delete failonerror="false"
                dir="${env.CATALINA_HOME}/webapps/${project.name}/WEB-INF/mapping"/>

        <delete failonerror="false"
                dir="${env.CATALINA_HOME}/webapps/${project.name}/WEB-INF/gridportlets"/>

    </target>

    <!-- =================================================================== -->
    <!-- Undeploys Web Application Resource Mappings From Grid Portlets      -->
    <!-- =================================================================== -->
    <target name="undeploy-gridportlets-mapping"
            description="Undeploys Web Application Resource Mappings From Grid Portlets">

        <echo>Undeploying web application resource mappings from Grid Portlets</echo>

        <delete failonerror="false">
            <fileset dir="${env.CATALINA_HOME}/webapps/gridportlets/WEB-INF/mapping/resources">
                <include name="*_${project.name}.xml"/>
            </fileset>
        </delete>

    </target>

    <!-- =================================================================== -->
    <!-- Undeploys Web Application Persistence Mappings From Grid Portlets   -->
    <!-- =================================================================== -->
    <target name="undeploy-gridportlets-persistence"
            description="Undeploys Web Application Persistence Mappings From Grid Portlets">

        <echo>Undeploying web application persistence mappings from Grid Portlets</echo>

        <delete failonerror="false">
            <fileset dir="${env.CATALINA_HOME}/webapps/gridportlets/WEB-INF/persistence">
                <include name="*_${project.name}.hbm.xml"/>
            </fileset>
        </delete>

    </target>

    <!-- =================================================================== -->
    <!-- Deploys Web Application Persistence Mappings From Grid Portlets   -->
    <!-- =================================================================== -->
    <target name="gridportlets-project-jar"
            description="Deploys grid portlet project classes and mapping files">

        <echo>Generating grid portlet project classes</echo>

        <delete failonerror="false" dir="build/src/${auto.services.dir}"/>

        <mkdir dir="build/${auto.services.dir}"/>

        <copy overwrite="true" todir="build/src/${auto.services.dir}">
            <fileset dir="${gridportlets.home}/config/project/src/${auto.services.dir}">
                <include name="*.java"/>
            </fileset>
            <mapper type="glob" from="*.java" to="*_${project.name}.java"/>
        </copy>

        <replace dir="build/src/${auto.services.dir}" token="@_PROJECT_NAME_@" value="${project.name}"/>
        <replace dir="build/src/${auto.services.dir}" token="@_PROJECT_TITLE_@" value="${project.title}"/>

        <echo>Compiling grid portlet project classes</echo>

        <javac srcdir="build/src/${auto.services.dir}"
            destdir="${build.classes}"
            classpathref="classpath"
            debug="${debug}"
            optimize="${optimize}"
            deprecation="false"/>

        <echo>Jarring grid portlet service classes</echo>

        <jar jarfile="${build.lib}/gridportlets-${project.name}.jar" basedir="${build.classes}">
            <include name="${auto.services.dir}/**"/>
            <include name="${project.name}/**" />
        </jar>

    </target>

    <!-- =================================================================== -->
    <!-- Deploys Web Application Persistence Mappings From Grid Portlets   -->
    <!-- =================================================================== -->
    <target name="gridportlets-project-entries"
            description="Generates grid portlet service entries in PortletServices.xml">

        <echo>Generating grid portlet service entries in PortletServices.xml</echo>

        <replace file="${env.CATALINA_HOME}/webapps/${project.name}/WEB-INF/PortletServices.xml">
            <replacetoken><![CDATA[<!--@ACTION_COMPONENT_FACTORY@-->]]></replacetoken>
            <replacevalue>
            <![CDATA[
            <service>
                <name>@PROJECT_TITLE@ Action Component Factory</name>
                <description>Creates @PROJECT_TITLE@ action components</description>
                <interface>org.gridsphere.gridportlets.services.ActionComponentFactory_@PROJECT_NAME@</interface>
                <implementation>org.gridsphere.gridportlets.services.ActionComponentFactory_@PROJECT_NAME@</implementation>
                <load-on-startup>true</load-on-startup>
            </service>
            ]]>
            </replacevalue>
        </replace>

        <replace file="${env.CATALINA_HOME}/webapps/${project.name}/WEB-INF/PortletServices.xml">
            <replacetoken><![CDATA[<!--@JOB_PROFILE_SERVICE@-->]]></replacetoken>
            <replacevalue>
            <![CDATA[
            <service>
                <name>@PROJECT_TITLE@ Job Profile Provider</name>
                <description>Provides @PROJECT_TITLE@ job profiles to the job profile registry</description>
                <interface>org.gridsphere.gridportlets.services.JobProfileProvider_@PROJECT_NAME@</interface>
                <implementation>org.gridsphere.gridportlets.services.JobProfileProvider_@PROJECT_NAME@</implementation>
                <load-on-startup>true</load-on-startup>
            </service>
            ]]>
            </replacevalue>
        </replace>

        <replace file="${env.CATALINA_HOME}/webapps/${project.name}/WEB-INF/PortletServices.xml">
            <replacetoken><![CDATA[<!--@RESOURCE_PROFILE_SERVICE@-->]]></replacetoken>
            <replacevalue>
            <![CDATA[
            <service>
                <name>@PROJECT_TITLE@ Resource Profile Provider</name>
                <description>Provides @PROJECT_TITLE@ resource profiles to the resource profile registry</description>
                <interface>org.gridsphere.gridportlets.services.ResourceProfileProvider_@PROJECT_NAME@</interface>
                <implementation>org.gridsphere.gridportlets.services.ResourceProfileProvider_@PROJECT_NAME@</implementation>
                <load-on-startup>true</load-on-startup>
            </service>
            ]]>
            </replacevalue>
        </replace>

        <replace file="${env.CATALINA_HOME}/webapps/${project.name}/WEB-INF/PortletServices.xml"
                 token="@PROJECT_NAME@" value="${project.name}"/>
        <replace file="${env.CATALINA_HOME}/webapps/${project.name}/WEB-INF/PortletServices.xml"
                 token="@PROJECT_TITLE@" value="${project.title}"/>

    </target>

    <!-- =================================================================== -->
    <!-- Setenv                                                           -->
    <!-- =================================================================== -->
    <target name="setenv" description="Check for libraries and print out config information">

        <!-- Make build directories -->
        <mkdir dir="src"/>
        <mkdir dir="lib"/>
        <mkdir dir="${project.build}"/>
        <mkdir dir="${build.lib}"/>
        <mkdir dir="${build.classes}"/>
        <mkdir dir="${build.webapp}"/>
        <mkdir dir="${build.docs}"/>

        <echo message="--- Build environment for ${project} ---"/>
        <echo message="--- Flags (Note: If the {property name} is displayed,"/>
        <echo message="           then the component is not present)"/>
        <echo message=""/>

        <echo message="ANT_HOME is set to = ${env.ANT_HOME}"/>
        <echo message="JAVA_HOME is set to = ${env.JAVA_HOME}"/>
        <echo message="CATALINA_HOME is set to = ${env.CATALINA_HOME}"/>

        <echo message="--- Property values ---"/>
        <echo message="debug=${debug}"/>
        <echo message="deprecation=${deprecation}"/>
        <echo message="optimize=${optimize}"/>
    </target>

</project>
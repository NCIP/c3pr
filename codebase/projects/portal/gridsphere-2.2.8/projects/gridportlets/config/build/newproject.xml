<project name="newproject" default="new-project" basedir=".">

    <!-- Configurable properties -->
    <property file="config/build/newproject.properties"/>

    <!-- =================================================================== -->
    <!-- Creates a new grid portlet project in projects directory            -->
    <!-- =================================================================== -->
    <target name="new-project" description="Creates a new portlet project in projects directory">
        <echo>Creating a New Grid Portlet Project</echo>

        <input message="Please enter a Project Name this will be used for your portlet web application and should be lowercase e.g. mygridportlets" addproperty="newproject.name"/>

        <property name="newproject.dir" value="${projects.dir}/${newproject.name}"/>

        <fail message="This project already exists! Please delete the old one in ${newproject.dir}">
            <condition>
                <available file="${newproject.dir}/build.xml"/>
             </condition>
        </fail>

        <input message="Please enter a Project Title e.g. My Grid Portlets" addproperty="newproject.title"/>

        <mkdir dir="${newproject.dir}"/>
        <mkdir dir="${newproject.dir}/config"/>
        <mkdir dir="${newproject.dir}/src"/>
        <mkdir dir="${newproject.dir}/lib"/>
        <mkdir dir="${newproject.dir}/lib/shared"/>
        <mkdir dir="${newproject.dir}/webapp"/>
        <mkdir dir="${newproject.dir}/webapp/WEB-INF"/>
        <mkdir dir="${newproject.dir}/webapp/WEB-INF/classes"/>
        <mkdir dir="${newproject.dir}/webapp/WEB-INF/persistence"/>
        <mkdir dir="${newproject.dir}/webapp/html"/>
        <mkdir dir="${newproject.dir}/webapp/jsp"/>

        <copy file="${gridsphere.home}/config/log4j.properties" tofile="${newproject.dir}/webapp/WEB-INF/classes/log4j.properties"/>

        <copy todir="${newproject.dir}/webapp/WEB-INF">
            <fileset dir="${gridsphere.home}/config/template">
                <exclude name="PortletServices.xml.tpl"/>
            </fileset>
            <mapper type="glob" from="*.xml.tpl" to="*.xml"/>
        </copy>
        <copy file="${gridsphere.home}/config/template/hibernate.properties" todir="${newproject.dir}/webapp/WEB-INF/persistence"/>

        <antcall target="checkjsr"/>

        <antcall target="copy-project-files"/>

        <antcall target="replace-tokens"/>

        <echo>Creation of new portlet project ${newproject.title} in projects/${newproject.name} is complete.</echo>
        <echo>Please edit src/ webapps/ and webapps/WEB-INF/{web.xml, layout.xml, PortletServices.xml} appropriately</echo>
        <echo>Please place portlets in src/**/portlets/ directory and service in src/**/services directory for proper compilation!</echo>
    </target>

    <!-- =================================================================== -->
    <!-- Updates a grid portlet project in projects directory                -->
    <!-- =================================================================== -->
    <target name="update-project" description="Updates existing grid portlet project with updated build files">

        <echo>Updating a Grid Portlet Project</echo>

        <input message="Please enter the project web app to update inside projects/ directory" addproperty="newproject.name"/>
        <property name="newproject.dir" value="../${newproject.name}"/>

        <fail message="The project does not exist. Please create one with 'ant new-project'">
            <condition>
                <not><available file="${newproject.dir}/build.xml"/></not>
             </condition>
        </fail>

        <input message="Please enter your project's Title e.g. My Grid Portlets" addproperty="newproject.title"/>

        <echo message="Overwriting ${newproject.dir}/build.xml, saving existing file to ${newproject.dir}/build.xml.bak"/>

        <copy file="${newproject.dir}/build.xml"
              tofile="${newproject.dir}/build.xml.bak"
              overwrite="true"/>
        <copy file="${newproject.dir}/build.properties"
              tofile="${newproject.dir}/build.properties.bak"
              overwrite="true"/>

        <copy failonerror="false" file="${newproject.dir}/config/gridportlets.xml"
              tofile="${newproject.dir}/config/gridportlets.bak"
              overwrite="true"/>
        <copy failonerror="false" file="${newproject.dir}/config/gridportlets.properties"
              tofile="${newproject.dir}/config/gridportlets.properties.bak"
              overwrite="true"/>

        <antcall target="copy-project-files"/>

        <antcall target="replace-tokens"/>

   </target>

    <!-- =================================================================== -->
    <!-- Replaces tokens                                                     -->
    <!-- =================================================================== -->
    <target name="replace-tokens">

        <replace file="${newproject.dir}/build.xml" token="@PROJECT_NAME@" value="${newproject.name}"/>
        <replace file="${newproject.dir}/build.properties" token="@PROJECT_NAME@" value="${newproject.name}"/>
        <replace file="${newproject.dir}/build.xml" token="@PROJECT_TITLE@" value="${newproject.title}"/>
        <replace file="${newproject.dir}/build.properties" token="@PROJECT_TITLE@" value="${newproject.title}"/>

        <replace file="${newproject.dir}/config/gridportlets.xml" token="@PROJECT_NAME@" value="${newproject.name}"/>
        <replace file="${newproject.dir}/config/gridportlets.properties" token="@PROJECT_NAME@" value="${newproject.name}"/>
        <replace file="${newproject.dir}/config/gridportlets.xml" token="@PROJECT_TITLE@" value="${newproject.title}"/>
        <replace file="${newproject.dir}/config/gridportlets.properties" token="@PROJECT_TITLE@" value="${newproject.title}"/>

    </target>

    <!-- =================================================================== -->
    <!-- Copies a grid portlet project files                                 -->
    <!-- =================================================================== -->
    <target name="copy-project-files">

        <copy overwrite="true" todir="${newproject.dir}">
            <fileset dir="config/project">
                <include name="build.xml"/>
                <include name="build.properties"/>
            </fileset>
        </copy>

        <mkdir dir="${newproject.dir}/config"/>
        <copy overwrite="true" todir="${newproject.dir}/config">
            <fileset dir="config/project/config">
                <include name="gridportlets.xml"/>
                <include name="gridportlets.properties"/>
            </fileset>
        </copy>

        <copy overwrite="false" todir="${newproject.dir}/webapp/WEB-INF/">
            <fileset dir="config/project/webapp/WEB-INF">
                <include name="ActionComponentTypes.xml"/>
                <include name="JobProfiles.xml"/>
                <include name="ResourceProfiles.xml"/>
                <include name="PortletServices.xml"/>
            </fileset>
        </copy>

        <mkdir dir="${newproject.dir}/webapp/WEB-INF/gridportlets"/>
        <mkdir dir="${newproject.dir}/webapp/WEB-INF/gridportlets/mapping"/>
        <mkdir dir="${newproject.dir}/webapp/WEB-INF/gridportlets/persistence"/>

        <copy overwrite="false" todir="${newproject.dir}/webapp/WEB-INF/gridportlets/mapping">
            <fileset dir="config/project/webapp/WEB-INF/gridportlets/mapping">
                <include name="ResourceMappings.xml"/>
            </fileset>
        </copy>

        <copy overwrite="false" todir="${newproject.dir}/webapp/WEB-INF/gridportlets/persistence">
            <fileset dir="config/project/webapp/WEB-INF/gridportlets/persistence">
                <include name="Resource.hbm.xml"/>
                <include name="Task.hbm.xml"/>
                <include name="TaskSpec.hbm.xml"/>
            </fileset>
        </copy>

     </target>

    <!-- =================================================================== -->
    <target name="checkjsr">
        <copy overwrite="true" file="${gridsphere.home}/config/template/gridsphere-portlet-jsr.xml" tofile="${newproject.dir}/webapp/WEB-INF/gridsphere-portlet.xml"/>
        <copy overwrite="true" file="${gridsphere.home}/config/template/portlet-jsr.xml" tofile="${newproject.dir}/webapp/WEB-INF/portlet.xml"/>
        <copy overwrite="true" file="${gridsphere.home}/config/template/layout-jsr.xml" tofile="${newproject.dir}/webapp/WEB-INF/layout.xml"/>
        <copy overwrite="true" file="${gridsphere.home}/config/template/web-jsr.xml" tofile="${newproject.dir}/webapp/WEB-INF/web.xml"/>
        <copy overwrite="true" file="${gridsphere.home}/config/template/group.sample.xml.tpl" tofile="${newproject.dir}/webapp/WEB-INF/group.sample.xml"/>
    </target>

</project>
<project name="c3pr-master-build" xmlns:ivy="antlib:org.apache.ivy.ant">
	<echo>This is the basedir: ${basedir}</echo>
    <property file="build.properties" />
	<property file="c3pr-ivy.properties" />
    <import file="${basedir}/common.xml"/>
	<property name="projects.dir" value="${basedir}/../projects" />
	
	
	<!-- ==================================================================
		target : buildlist
	====================================================================== -->
  	<target name="buildlist" depends="load-ivy" unless="buildlist.done" description="Will find the correct order of build dependency"> 
    	<ivy:buildlist reference="build-path">
    		<fileset file="${basedir}/ivy-build.xml" />
      		<fileset file="${projects.dir}/esb-client/ivy-build.xml" />
    		<fileset file="${projects.dir}/core/ivy-build.xml" />
    		<fileset file="${projects.dir}/web/ivy-build.xml" />
    	</ivy:buildlist>
  		<property name="buildlist.done" value="true" />
  		<echo message="buildList : ${build-path}" />
  	</target>
	
	<!-- ==================================================================
		target : publish-all
	====================================================================== -->
  	<target name="publish-all" depends="buildlist, clean" 
  			description="compile, jar and publish all projects in the right order, publishes them into local repository">
   		 <subant target="publish-local" buildpathref="build-path" />
  	</target>
	
	<!-- ==================================================================
		target : release-all
	====================================================================== -->
	<target name="release-all" depends="buildlist" 
	  			description="compile, jar and publish all projects in the right order, then releases it to Shared Repository">
	   	<subant target="publish" buildpathref="build-path" />
	</target>
	
	<!-- ==================================================================
		target : resolve-all
	====================================================================== -->
   <target name="resolve-all" depends="buildlist" 
   		description="Will call the resolve target on each of the module">
   		<subant target="resolve" buildpathref="build-path" />
   </target>
	
	<!-- ==================================================================
		target : clean-all
	====================================================================== -->
  <target name="clean-all" depends="buildlist" description="clean all projects">
    <subant target="clean" buildpathref="build-path" />
  </target>
	
	<!-- ==================================================================
		target : clean
	====================================================================== -->
  <target name="clean" depends="clean-all, clean-repo" 
  			description="clean delete repository, and all projects" />
	
	<target name="clean-repo" description="cleans the local repository">
		<delete dir="${local.repo.dir}"/>
	</target>
	
	<!-- ==================================================================
		target : clean-cache
	====================================================================== -->
	<target name="clean-cache" depends="load-ivy" description="Cleans the ivy cache">
		<ivy:cleancache/>
	</target>
	<!-- ==========================================================
		target : migrate
		This will delegate the call to c3pr-core:migrate, this is added
		to do migrate and build as a single job using hudson. 
	=============================================================-->
	<target name="migrate">
		<subant target="migrate" buildpath="${projects.dir}/core/ivy-build.xml" />
	</target>

	<!-- ==========================================================
		target : migrate-test
		This will delegate the call to c3pr-core:migrate-test, this is added
		to do migrate and build as a single job using hudson. 
	=============================================================-->
	<target name="migrate-test">
		<subant target="migrate-test" buildpath="${projects.dir}/core/ivy-build.xml" />
	</target>

	<!--- =================================================================================
		target : javadoc
	======================================================================================= -->
    <target name="javadoc" description="Compile the Javadoc API documentation to javadoc dir">
        <mkdir dir="${javadoc.dir}"/>
        <javadoc
        	classpathref="lib.path.id"
        	destdir="${javadoc.dir}"
        	use="true"
        	protected="true"
        	version="true"
        	windowtitle="C3PR API Documentation"
        	Overview="${javadoc.dir}/package.html"
        	doctitle="C3PR API Documentation"
        	link="${sun.javadoc.link}">
        	<packageset dir="${basedir}" defaultexcludes="yes" >
   				<include name="**/main/java/**/*"/>
		    </packageset>
        </javadoc>


    </target>

	 <!--Does a local build. For Developers use only -->
    <target name="deploy-webapp-local" depends="build-core"
            description="Builds all c3pr modules and deploys webapp on your web/web local">
    	<subant target="deployLocal" buildpath="${projects.dir}/web/ivy-build.xml" >
    		<property name="skip.test" value="true"></property>
    	</subant>
    </target>
	
    <target name="deploy-webapp" depends="build-core"
            description="Builds all c3pr modules and deploys webapp on your web/web local">
    	<ant target="deploy" antfile="${projects.dir}/web/ivy-build.xml" dir="${projects.dir}/web" inheritall="false">
			<property name="env.skip.test" value="true"></property>
			<property name="env.CATALINA_HOME" value="${env.CATALINA_HOME}"/>
    	</ant>
    </target>
	
	<!-- ==========================================================
		target : tomcat.security
		This will delegate the call to c3pr-core:tomcat.security.
	=============================================================-->
	<target name="tomcat.security" depends="debug-database-info" >
		<ant target="tomcat.security" antfile="${projects.dir}/core/ivy-build.xml" inheritall="false" dir="${projects.dir}/core">
			<property name="env.CATALINA_HOME" value="${env.CATALINA_HOME}"/>
		</ant>
	</target>
	
	<target name="build-core" depends="clean-repo, debug-database-info"
            description="Builds all c3pr modules that core depends on and create the core jar">
		<ant target="publish-local" antfile="${basedir}/ivy-build.xml" inheritall="false">
    		<property name="env.skip.test" value="true"></property>
    	</ant>
    	<ant target="publish-local" antfile="${projects.dir}/esb-client/ivy-build.xml" dir="${projects.dir}/esb-client" inheritall="false">
    		<property name="env.skip.test" value="true"></property>
    	</ant>
		<ant target="publish-local" antfile="${projects.dir}/core/ivy-build.xml" dir="${projects.dir}/core" inheritall="false">
    		<property name="env.skip.test" value="true"></property>
    	</ant>
    </target>
	

	<!-- ==========================================================
		target : Installer targets
	=============================================================-->
	
	<target name="create-online-installer" depends="prepareInstallerForRelease"
            description="Builds the installer project">
		<subant target="build-installer" buildpath="${projects.dir}/installer/ivy-build.xml"/>
	</target>


    <target name="create-offline-installer" depends="prepareInstallerForRelease"
            description="Builds the offline version of the installer">
        <subant target="build-offline-installer" buildpath="${projects.dir}/installer/ivy-build.xml"/>
    </target>
	
	<!-- =============================================================== -->
    <!-- create target to create a release of Installer  project          -->
    <!-- =============================================================== -->
    <target name="prepareInstallerForRelease" depends="clean">
        <property name="project.archive" value="c3prv2-installpack.zip"/>
        <mkdir dir="${projects.dir}/installer/ext"/>
        <zip destfile="${projects.dir}/installer/ext/${project.archive}">
            <zipfileset dir="${basedir}" prefix="antfiles"/>
            <zipfileset dir="${projects.dir}/core" prefix="projects/core"/>
            <zipfileset dir="${projects.dir}/web" prefix="projects/web"/>
            <zipfileset dir="${projects.dir}/esb-client" prefix="projects/esb-client"/>
            <zipfileset dir="${projects.dir}/grid" prefix="projects/grid"/>
            <zipfileset dir="${projects.dir}/../share" prefix="share"/>
        </zip>
    </target>

</project>

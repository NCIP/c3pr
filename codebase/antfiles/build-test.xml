<?xml version="1.0"?>

<!-- ================================================================= -->
<!-- C3PR Master test build file                                       -->
<!-- ================================================================= -->
<project name="c3pr-2.0-test" default="test" basedir=".">

    <!-- =============================================================== -->
    <!-- Call test for each project and aggregates the log resutls       -->
    <!-- =============================================================== -->
    <target name="test" depends="prepare, test-prepare" description="Tests all the projects.">
        <mkdir dir="${junit.results.dir}"/>
        <mkdir dir="${testcoverage.dir}"/>
        <!-- Clean out old logs first -->
        <delete>
            <fileset dir="${junit.results.dir}">
                <include name="*" />
            </fileset>
        </delete>


        <for list="${testable.projects.list}" parallel="true" param="project.name" trim="true">
            <sequential>
                <echo message="Testing project @{project.name}." />
                <trycatch property="@{project.name}.test.failed.message">
                    <try>
                        <ant inheritall="false" dir="${projects.dir}/@{project.name}" antfile="build.xml" target="test">
                            <property name="junit.results.dir" value="${junit.results.dir}" />
                        </ant>
                    </try>
                    <catch>
                        <fail message="@{project.name} Tests failed (${@{project.name}.test.failed.message})" if="test.failfast" />
                        <echo message="@{project.name} Tests failed (${@{project.name}.test.failed.message}), proceeding with other tests, but build will fail at completion." />
                        <property name="test.failed" value="true" />
                    </catch>
                </trycatch>
            </sequential>
        </for>
        <trycatch property="test.report.failed.message">
            <try>
                <mkdir dir="${junit.results.dir}/report" />
                <junitreport todir="${junit.results.dir}">
                    <fileset dir="${junit.results.dir}">
                        <include name="TEST-*.xml" />
                    </fileset>
                    <report format="frames" todir="${junit.results.dir}/report" />
                </junitreport>
                <echo message="Created test report in ${junit.results.dir}/report" />
            </try>
            <catch>
                <echo message="Test Report creation failed (${test.report.failed.message})!" />
            </catch>
        </trycatch>

        <fail message="Tests failed!! Consult the logs for details." if="test.failed" />
    </target>

    <!-- =========================================================================== -->
    <!-- Call test for each system test project and aggregates the log resutls       -->
    <!-- =========================================================================== -->
    <target name="test-system" depends="prepare, test-prepare" description="Tests all the system test projects.">
        <mkdir dir="${junit.results.dir}"/>
        <mkdir dir="${testcoverage.dir}"/>

        <for list="${system.testable.projects.list}" parallel="true" param="project.name" trim="true">
            <sequential>
                <echo message="Testing project @{project.name}." />
                <instrument tempDir="${instrumentation.temp.dir}" datafile="${testcoverage.dir}/@{project.name}.ser">
                    <artifact refid="c3pr.@{project.name}.jars" />
                </instrument>
                <ant inheritall="false" dir="${projects.dir}/@{project.name}" antfile="build.xml" target="test">
                    <property name="junit.results.dir" value="${junit.results.dir}" />
                    <property name="testcoverage.datafile" location="${testcoverage.dir}/@{project.name}.ser"/>
                    <property name="cobertura.home" location="${cobertura.home}"/>
                </ant>
                <deinstrument tempDir="${instrumentation.temp.dir}">
                    <artifact refid="c3pr.@{project.name}.jars" />
                </deinstrument>
            </sequential>
        </for>

        <!-- clean up instrumentation -->
        <delete dir="${instrumentation.temp.dir}"/>
    </target>

    <target name="test-prepare" depends="prepare, defineArtifacts" description="Prepare for running tests">
        <property name="testcoverage.dir" location="${reports.dir}/testcoverage"/>
        <property name="testcoverage.temp.dir" location="${reports.dir}/testcoverage"/>
        <property name="instrumentation.temp.dir" location="${basedir}/temp"/>

        <taskdef name="instrument" classname="gov.nih.nci.cagrid.ant.Instrument" loaderref="artifact">
            <classpath>
                <pathelement location="${management.dir}/build" />
                <path refid="cobertura.classpath"/>
            </classpath>
        </taskdef>
        <taskdef name="deinstrument" classname="gov.nih.nci.cagrid.ant.Deinstrument" loaderref="artifact">
            <classpath>
                <pathelement location="${management.dir}/build" />
                <path refid="cobertura.classpath"/>
            </classpath>
        </taskdef>

        <mkdir dir="${testcoverage.dir}"/>
        <delete>
            <fileset dir="${testcoverage.dir}">
                <include name="*.ser"/>
            </fileset>
        </delete>
        <mkdir dir="${testcoverage.dir}"/>

        <delete dir="${instrumentation.temp.dir}"/>
        <mkdir dir="${instrumentation.temp.dir}"/>
    </target>
</project>